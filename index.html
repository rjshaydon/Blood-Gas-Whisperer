<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Haydon Method Blood Gas App</title>
<style>
  /* Shared layout for Summary and Recommendations */
  .summary-content {
    display: flex;
    flex-direction: column;
  }

   /* Title bar styles */
   .title-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    width: 100%;
    box-sizing: border-box;
  }
  
  .title-content {
    display: flex;
    flex-direction: row;
    align-items: center;
  }
  
  .title-text {
    font-weight: bold;
    font-size: 1.25rem;
  }
  
  .title-icon {
    height: 2.5rem;
    margin-right: 1rem;
  }

  @media (orientation: portrait) and (max-width: 768px) {
    .title-text {
      display: flex;
      flex-direction: column;
    }
    
    .title-subtitle {
      /* adjust for the by Dr Richard Haydon FACEM font size */
      font-size:0.85em;
    }
  }
  
  /* Shared layout for Summary and Recommendations */
  .summary-content {
    display: flex;
    flex-direction: column;
  }

  @media (min-width: 768px) {
    /* Desktop: side-by-side Summary and Recommendations in all modes */
    .summary-content {
      display: flex;
      flex-direction: row;
      gap: 1rem;
    }
    .summary .summary-text,
    .summary .recommendations {
      flex: 1;
      font-size: 1.125rem;
      padding-bottom: 1rem;
    }
    /* Match input font-size in both light and dark on desktop */
    .input-group input {
      font-size: 1.125rem;
    }
    /* Align titles level in desktop side-by-side layout */
    .summary-content .summary-text,
    .summary-content .recommendations {
      align-self: flex-start;
    }
    .summary-content .recommendations {
      margin-top: 0 !important;
    }
  }

  html, body {
    overflow-x: hidden;
  }

  /* Light mode styles */
  @media (prefers-color-scheme: light) {
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      color: #2c3e50;
      background: #ecf0f1;
    }
    .tabs {
      width: 44px;
      background: #bdc3c7;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
    }
    .tab {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      padding: 1rem 0.5rem;
      color: #2c3e50;
      cursor: pointer;
      text-align: center;
      border-bottom: 1px solid #95a5a6;
    }
    .tab.active {
      background: #ecf0f1;
      font-weight: bold;
    }
    .main {
      flex-grow: 1; height: 100vh; overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .title-bar {
      background: #ffffff;
      border-bottom: 1px solid #e0e0e0;
    }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      /* overflow-x intentionally omitted to allow only vertical scroll */
      background: #ffffff;
    }
    .step {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 1rem;
    }
    .input-group {
      display: grid;
      grid-template-columns: 100px 80px;
      column-gap: 0.5rem;
      row-gap: 0.5rem;
      justify-items: center;
      align-items: center;
      }
    .input-group label {
      text-align: right;
      width: 100px;
      color: #2c3e50;
    }
    input {
      width: 80px;
      padding: 0.5rem;
      background: #ffffff;
      color: #2c3e50;
      border: 1px solid #7f8c8d;
      border-radius: 4px;
    }
    input:disabled,
    input[readonly] {
      background: #f0f0f0;
      color: #95a5a6;
    }
    .interpretation {
      background: #f0f0f0;
      padding: 0.5rem;
      border-radius: 4px;
      min-width: 180px;
      max-width: 300px;
      word-wrap: break-word;
      margin-left: 1.5rem;
      font-size: 0.875rem;
      color: #2c3e50;
    }
    .summary {
      touch-action: none;
      overscroll-behavior: contain;  flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      padding: 0.5rem;
      padding-bottom: 1.5rem;
      padding-left: 1.5rem;
      border-top: 2px solid #95a5a6;
      background: #ffffff;
      color: #2c3e50;
      font-size: 0.875rem;
      /* min-height removed to allow natural expansion */
      display: flex;
      flex-direction: column;
      overscroll-behavior: none;
    }
    
    /* .summary-content layout now handled in shared layout above */
    
    .recommendations {
      margin-top: 1em;
    }
    
    .recommendations-title {
      font-weight: bold;
      margin-bottom: 0.5em;
    }
    /* Match Summary title spacing to Recommendations */
    .summary-text > strong {
      display: block;
      margin-bottom: 0.5em;
    }
    .summary-text > br {
      display: none;
    }
    
    /* Two-column layout for wider screens */
    @media (min-width: 768px) {
      .recommendations {
        margin-top: 1rem;
      }
      /* .summary .summary-text and .summary .recommendations layout handled in shared layout */
      /* .summary padding-bottom handled in shared layout */
    }
  }

  /* Dark mode styles */
  @media (prefers-color-scheme: dark) {
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      color: #ecf0f1;
      background: #1e272e;
    }
    .tabs {
      width: 44px;
      background: #2c3e50;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1rem;
    }
    .tab {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      padding: 1rem 0.5rem;
      color: white;
      cursor: pointer;
      text-align: center;
      border-bottom: 1px solid #34495e;
    }
    .tab.active {
      background: #34495e;
      font-weight: bold;
    }
    .main {
      flex-grow: 1; height: 100vh; overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .title-bar {
      background: #1e272e;
      border-bottom: 1px solid #34495e;
    }
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      /* overflow-x intentionally omitted to allow only vertical scroll */
    }
    .step {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 1rem;
    }
    .input-group {
      display: grid;
      grid-template-columns: 100px 80px;
      column-gap: 0.5rem;
      row-gap: 0.5rem;
      justify-items: center;
      align-items: center;
      }
    .input-group label {
      text-align: right;
      width: 100px;
    }
    input {
      width: 80px;
      padding: 0.5rem;
      background: #2d3436;
      color: white;
      border: 1px solid #636e72;
      border-radius: 4px;
    }
    input:disabled,
    input[readonly] {
      background: #2f3640;
      color: #7f8c8d;
    }
    .interpretation {
      background: #2f3640;
      padding: 0.5rem;
      border-radius: 4px;
      min-width: 180px;
      max-width: 300px;
      word-wrap: break-word;
      font-size: 0.875rem;
    }
    .summary {
      touch-action: none;
      overscroll-behavior: contain;  flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      padding: 0.5rem;
      padding-bottom: 1.5rem;
      padding-left: 1.5rem;
      border-top: 2px solid #34495e;
      background: #1e272e;
      font-size: 0.875rem;
      overscroll-behavior: none;
    }
    /* No layout-related rules for .summary or .summary-content here; only colour-related declarations remain */
    }
    .recommendations {
      margin-top: 1rem;
      padding-bottom: 1rem
    }
  /* Ensure recommendations title is bold in all colour schemes */
  .recommendations-title {
    font-weight: bold !important;
  }

  /* Override to adjust input width and label positioning */
  .input-group {
    margin-left: -2.5rem !important;
  }
  .input-group input {
    width: 5ch !important;
    margin-left: -0.5rem !important;
  }

  .interpretation {
    margin-left: 0.5rem !important;
  }

  /* Prevent step tab text wrapping */
  .tab {
    white-space: nowrap !important;
  }

  /* Mobile-specific: cap interpretation box width on small screens */
  @media (max-width: 600px) {
    .interpretation {
      max-width: 200px !important;
      min-width: 145px !important;
    }
    /* Prevent iOS auto-zoom on input focus */
    input, select, textarea {
      font-size: 1.25rem !important;
    }
    .content {
      overflow-y: auto !important;
    }
    .summary {
      touch-action: none;
      overscroll-behavior: contain;  flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      overflow-y: hidden !important;
    }
    /* Removed .summary .summary-text and .summary .recommendations padding-bottom override */
    .recommendations {
      margin-top: 1rem !important;
    }
  }

  /* Medium screens – between mobile and tablet/desktop */
  @media (min-width: 601px) and (max-width: 767px) {
    /* Adjust font size for value entry fields on medium screens */
    .input-group input {
      font-size: 1.125rem;
    }
    .summary .summary-text,
    .summary .recommendations {
      font-size: 1.125rem;
      padding-bottom: 1rem;
    }
    .summary {
      padding-bottom: 2rem;
    }
  }



/* Smartphone landscape: fixed 98px tabs + 40/60 split of what's left */
@media (orientation: landscape) and (max-height: 500px) {
  /* Force vertical stacking of Summary and Recommendations on mobile landscape */
  .summary-content {
    flex-direction: column !important;
  }
  .summary .summary-text,
  .summary .recommendations {
    width: 100% !important;
    padding-bottom: 1rem !important;
  }

  /* 1) Use the <body> as a 3-column grid: tabs in col 1, main area in cols 2–3 */
  body {
    display: grid !important;
    grid-template-columns: 50px 2fr 3fr;
    grid-template-rows: 100vh;
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
  }

  /* 2) Tabs live in column 1 */
  .tabs {
    grid-column: 1;
    grid-row: 1;
    /* you can leave width:98px here as a reminder, but the track fixes it */
    /* width: 98px; */
    display: flex;           
    flex-direction: column;
    align-items: flex-end;    /* ← this makes every .tab (and the pseudo-element) hug the right edge */
  }

  /* 3) .main spans columns 2–3, and becomes *another* grid */
  .main {
    grid-column: 2 / span 2;
    grid-row: 1;
    display: grid !important;
    grid-template-columns: 45fr 55fr;  /* 40% / 60% of the main area */
    grid-template-rows: auto 1fr;      /* Title bar row and content row */
    height: 100vh;
    margin: 0;
    padding: 0;
  }
  
  /* Title bar spans both columns in landscape mode */
  .title-bar {
    grid-column: 1 / span 2;
    grid-row: 1;
    z-index: 10; /* Ensure title bar stays on top */
  }
  
  /* 4) .content sits in the first sub-column */
  .content {
    grid-column: 1;
    grid-row: 2;
    height: calc(100vh - 4rem); /* Adjust for title bar */
    overflow-y: auto;
  }

  /* 5) .summary sits in the second sub-column */
  .summary {
    grid-column: 2;
    grid-row: 2; /* Position in the second row, below title bar */
    height: calc(100vh - 4rem); /* Adjust for title bar */
    overflow-y: auto;            /* allow vertical scroll only when needed */
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain; /* prevent parent scrolling */
    touch-action: pan-y;         /* allow touch scrolling vertically */
    display: flex;
    flex-direction: column;
    border-left: 2px solid #95a5a6;
    margin: 0;
    padding: 0.5rem 1rem 2rem 1rem; /* bottom padding increased to 2rem */
    position: relative; /* Ensure proper stacking context */
    z-index: 1; /* Lower than title bar */
  }

  .recommendations {
    margin-top: 1rem;
  }

  /* 6) Make interpretation boxes stretch full-width inside each panel */
  .interpretation {
    align-self: stretch;
    max-width: none;
  }
}

  /* Tab visual tweaks - Base styles for all modes */
  .tabs { 
    touch-action: manipulation; 
    overscroll-behavior: contain; 
  }
  
  /* Common tab styles for all screen modes */
  .tab {
    position: relative;
    width: auto;
    margin-left: auto;
    text-align: right;
    padding: 0.5rem 0.75rem 0.5rem 0.75rem;
  }
  
  /* Common active tab styles for all screen modes */
  .tab.active {
    position: relative;
    background: transparent;
    z-index: 1;
    margin-left: 0;
    box-shadow: none;
  }
  
  /* Use pseudo-element for background in all modes */
  .tab.active::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    left: -10px;
    background: #ffffff;  /* Light mode: match content background */
    border-top-right-radius: 6px;
    border-bottom-right-radius: 6px;
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    z-index: -1;
  }
  
  /* Dark mode active tab background for all modes */
  @media (prefers-color-scheme: dark) {
    .tab.active::before {
      background: #1e272e;  /* Dark mode: match content background */
    }
  }
  
  /* Portrait mode specific adjustments */
  @media (orientation: portrait) {
    .summary {
      padding-bottom: 2rem !important;
    }
    .tabs {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .tab.active::before {
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      right: 0;  /* Extend to the right edge */
    }
  }
   

</style>
</head>
<body>
  <div class="tabs">
    <div class="tab active" onclick="showStep(1, true)">Step 1</div>
    <div class="tab" onclick="showStep(2, true)">Step 2</div>
    <div class="tab" onclick="showStep(3, true)">Step 3</div>
    <div class="tab" onclick="showStep(4, true)">Step 4</div>
    <div class="tab" onclick="showStep(5, true)">ABG</div>
  </div>
  <div class="main">
    <div class="title-bar">
      <div class="title-content">
        <img src="icon.png" alt="App Icon" class="title-icon">
        <div class="title-text">
          <span>The Blood Gas Whisperer</span>
          <span class="title-subtitle">by Dr Richard Haydon FACEM</span>
        </div>
      </div>
    </div>
    <div class="content">
      <div class="step" id="step1">
        <div class="input-group">
          <label for="na">Na⁺</label><input type="text" inputmode="decimal" id="na" step="1" value="135" oninput="update()" class="value-field">
          <label for="cl">Cl⁻</label><input type="text" inputmode="decimal" id="cl" step="1" value="98" oninput="update()" class="value-field">
        </div>
        <div class="interpretation" id="interp1"></div>
      </div>
      <div class="step" id="step2">
        <div class="input-group">
          <label for="hco3">HCO₃⁻</label><input type="text" inputmode="decimal" id="hco3" step="0.1" value="24" oninput="update()" class="value-field">
        </div>
        <div class="interpretation" id="interp2"></div>
      </div>
      <div class="step" id="step3">
        <div class="input-group">
          <label for="co2">CO₂</label><input type="text" inputmode="decimal" id="co2" step="0.1" value="40" oninput="update()" class="value-field">
        </div>
        <div class="interpretation" id="interp3"></div>
      </div>
      <div class="step" id="step4">
        <div class="input-group">
          <label for="k">K⁺</label>
          <input type="text" inputmode="decimal" id="k" step="0.1" value="4.0" oninput="update()" class="value-field">
          <label for="glucose">Glucose</label>
          <input type="text" inputmode="decimal" id="glucose" step="0.1" value="5.5" oninput="update()" class="value-field">
          <label for="lactate">Lactate</label>
          <input type="text" inputmode="decimal" id="lactate" step="0.1" value="1.0" oninput="update()" class="value-field">
          <label for="ph">pH</label>
          <input type="text" id="ph" value="" readonly>
        </div>
        <div class="interpretation" id="interp4" style="align-self: flex-start; margin-top: 0;"></div>
      </div>
      <!-- New Step 5 -->
      <div class="step" id="step5" style="flex-direction: column; align-items: flex-start;">
        <div style="font-weight: bold; margin-top: 2rem; margin-bottom: 0.75rem; white-space: nowrap; ">
          <span>O₂ and Hb analysis <em>– ABG only</em></span>
          <input type="checkbox" id="toggleO2hb" style="margin-left: 0.5rem; vertical-align: middle;">
        </div>
        <div style="display: flex; flex-direction: row; align-items: center; width: 100%; margin-bottom: 0.5rem;"> <!-- Added margin-bottom for spacing -->
          <div class="input-group">
            <label for="fio2" class="o2hb-field">FiO₂</label>
            <input type="text" inputmode="decimal" id="fio2" step="1" value="21" oninput="update()" class="o2hb-field value-field">
            <label for="pao2" class="o2hb-field">PaO₂</label>
            <input type="text" inputmode="decimal" id="pao2" value="100" oninput="update()" class="o2hb-field value-field">
          </div>
          <div class="interpretation o2hb-field" id="interpO2hb">
          </div>
        </div>
        <!-- New Hb/F-Hb section MOVED HERE and margin-top removed -->
        <div style="display: flex; flex-direction: row; align-items: flex-start; width: 100%;">
          <div class="input-group">
            <label for="hb" class="o2hb-field">Hb</label>
            <input type="text" inputmode="decimal" id="hb" value="140" oninput="update()" class="o2hb-field value-field">

            <label for="fo2hb" class="o2hb-field">FO₂Hb</label>
            <input type="text" inputmode="decimal" id="fo2hb" value="97.0" step="0.1" oninput="update()" class="o2hb-field value-field">

            <label for="fmethb" class="o2hb-field">FMetHb</label>
            <input type="text" inputmode="decimal" id="fmethb" value="0.0" step="0.1" oninput="update()" class="o2hb-field value-field">

            <label for="fcohb" class="o2hb-field">FCOHb</label>
            <input type="text" inputmode="decimal" id="fcohb" value="1.0" step="0.1" oninput="update()" class="o2hb-field value-field">

            <label for="fhhb" class="o2hb-field">FHHb</label>
            <input type="text" inputmode="decimal" id="fhhb" value="2.0" step="0.1" oninput="update()" class="o2hb-field value-field">
          </div>
          <div class="interpretation o2hb-field" id="interpHbFhb"><!-- Removed style="align-self: stretch;" -->
            <!-- Interpretation for Hb and F-Hb values will go here -->
          </div>
        </div>
      </div>
    </div>
    <div class="summary" id="summary">
      <div class="summary-content">
        <div class="summary-text" id="summary-text"></div>
        <div class="recommendations" id="recommendations-container">
          <div class="recommendations-title" id="recommendations-title">Recommendations:</div>
          <div id="recommendations-text"></div>
        </div>
      </div>
    </div>
  </div>
<script>
function showStep(step, focusFirst = false) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', i===step-1));
  document.querySelectorAll('.step').forEach((s,i) => {
    const inputs = s.querySelectorAll('input');
    if (i <= window.maxStep-1) {          // once unlocked, stay active
      inputs.forEach(inp => { inp.readOnly = false; inp.tabIndex = 0; });
      s.style.opacity = '1';
    } else {
      s.style.opacity = '0.5';
    }
  });
  window.currentStep = step;   // remember which step is active
  window.maxStep = Math.max(window.maxStep, step);
  // Ensure all steps up to and including the selected step are activated
  document.querySelectorAll('.step').forEach((s, i) => {
    if (i <= step - 1) {
      const inputs = s.querySelectorAll('input');
      inputs.forEach(inp => {
        inp.readOnly = false;
        inp.tabIndex = 0;
      });
      s.style.opacity = '1';
    }
  });
  // Automatically tick the ABG checkbox when clicking the ABG tab
  if (step === 5) {
    const toggle = document.getElementById('toggleO2hb');
    if (!toggle.checked) {
      toggle.checked = true;
      toggle.dispatchEvent(new Event('change'));
    }
  }
  // If requested, move cursor to the first input (FiO₂ for ABG)
  if (focusFirst) {
    const stepEl = document.getElementById(`step${step}`);
    if (stepEl) {
      let targetInput;
      if (step === 5) {
        targetInput = document.getElementById('fio2');
      } else {
        targetInput = stepEl.querySelector('input');
      }
      if (targetInput) {
        // Delay allows previous focus handlers to finish without recursion
        setTimeout(() => targetInput.focus(), 0);
      }
    }
  }
  update();                    // refresh visibility rules
}

// Globals
window.currentStep = 1;
window.maxStep = 1;
window.initialNa   = parseFloat(document.getElementById('na').value);
window.initialCl   = parseFloat(document.getElementById('cl').value);
window.naClDirty = false;
window.initialHco3 = parseFloat(document.getElementById('hco3').value);
window.agDirty = false;

function update() {
  const get = id => parseFloat(document.getElementById(id).value) || 0;
  const set = (id, html) => document.getElementById(id).innerHTML = html;
  const na = get('na'), cl = get('cl'), hco3 = get('hco3'), co2 = get('co2');
  if (na !== window.initialNa || cl !== window.initialCl) {
    window.naClDirty = true;
  }
  const hco3Value = get('hco3');
  if (hco3Value !== window.initialHco3) {
    window.agDirty = true;
  }
  // Scratch holders for later summary building
  let aaPlainText = '';
  let fhbPlainText = '';
  const glucose = get('glucose'), k = get('k'), lactate = get('lactate');
  const hb = get('hb'); // Re-added hb
  const fo2hb = get('fo2hb');
  const fcohb = get('fcohb');
  const fhhb = get('fhhb');
  const fmethb = get('fmethb');

  const naclDelta = Math.round(na - cl);
  // Anion gap rounded to nearest whole number
  const ag = Math.round(naclDelta - hco3);
  const interp1El = document.getElementById('interp1');
  if (window.naClDirty || na !== window.initialNa || cl !== window.initialCl) {
    // Determine chloride arrow indicator based on NaClΔ thresholds
    let clArrow = '';
    if (naclDelta > 45) {
      clArrow = '(↓Cl⁻)';
    } else if (naclDelta <= 25) {
      clArrow = '(↑↑Cl⁻)';
    } else if (naclDelta > 25 && naclDelta < 30) {
      clArrow = '(↑Cl⁻)';
    }
    set('interp1', `<strong>NaClΔ:</strong> ${naclDelta} ${clArrow}`);
    interp1El.style.display = '';
  } else {
    interp1El.style.display = 'none';
  }

  const interp2El = document.getElementById('interp2');
  if (window.maxStep >= 2 && (window.agDirty || ag <= 8 || ag >= 16)) {
    // Determine RAGMA arrow indicator based on AG thresholds
    let agArrow = '';
    if (ag <= 8) {
      agArrow = '(↓)';
    } else if (ag >= 16 && ag <= 17) {
      agArrow = '(↑)';
    } else if (ag > 17) {
      agArrow = '(↑↑)';
    }
    set('interp2', `<strong>Anion Gap:</strong> ${ag} ${agArrow}`);
    interp2El.style.display = '';
  } else {
    interp2El.style.display = 'none';
  }

  let interp3 = '';

  /* ---------- Respiratory evaluation (pure & mixed) ---------- */
  const deltaCO2  = co2 - 40;          // deviation from 40 mmHg
  const deltaHCO3 = hco3 - 24;         // deviation from 24 mmol L⁻¹

  /* “MetabolicDisturbance” flags any significant primary metabolic process.  
     Normal NaClΔ is 30‑45; normal/low‑normal AG is ≤ 16. */
  const metabolicDisturbance =

  /*. // I have disabled this code...
        (hco3 <= 20 || hco3 >= 30) ||          // bicarbonate out of normal band 
  */

        (naclDelta <= 25 || naclDelta >= 45) ||// chloride‑based clues
        (ag >= 16);                            // raised anion‑gap

  /* Candidate for a *pure* respiratory disorder → all metabolic markers normal.  
     Low‑normal AG (≤ 8) is tolerated because chronic respiratory acidosis can
     lower the AG slightly without implying a metabolic process. */
  const pureRespCandidate =
        (!metabolicDisturbance && ag <= 16);   // AG up to 16 regarded as normal

  /* ------------------------------------------------------------------ */
  /* 1. No metabolic disturbance present – evaluate pure respiratory status */
  if (!metabolicDisturbance) {
    if (Math.abs(deltaCO2) <= 5) {
      // Normal CO₂ only when NaClΔ is 30–45
      if (naclDelta >= 30) {
        interp3 = '<strong>Normal acid/base status</strong>';
      } else {
        interp3 = '<strong>Normal CO₂</strong>';
      }
    } else {
      /* ——— Pure primary respiratory disorders ——— */

      if (deltaCO2 > 5) {                       // respiratory acidosis
        const expA = (deltaCO2 / 10) * 1;       // acute compensation
        const expC = (deltaCO2 / 10) * 4;       // chronic compensation
        if (deltaHCO3 <= expA + 0.5) {
          respType = 'Acute resp acidosis';
        } else if (deltaHCO3 >= expC - 0.5) {
          respType = 'Chronic resp acidosis';
        } else {
          respType = 'Acute‑on‑chronic resp acidosis';
        }

      } else if (deltaCO2 < -5) {               // respiratory alkalosis
        const absChange = Math.abs(deltaCO2);
        const expA = -(absChange / 10) * 2;     // acute compensation
        const expC = -(absChange / 10) * 5;     // chronic compensation
        if (deltaHCO3 >= expA - 0.5) {
          respType = 'Acute resp alkalosis';
        } else if (deltaHCO3 <= expC + 0.5) {
          respType = '?Chronic resp alkalosis';
        } else {
          respType = 'Acute‑on‑chronic resp alkalosis';
        }
      }

      interp3 = `<strong>${respType}</strong>`;
    }

  /* ------------------------------------------------------------------ */
  /* 2. Metabolic disturbance present – keep original compensation logic */
  } else {

    /* 2a. Metabolic acidosis – Winter’s formula */
    if ((naclDelta < 30 || ag > 14) && hco3 <= 20) {
      const expected = Math.round(1.5 * hco3 + 8);
      if (co2 >= expected - 5 && co2 <= expected + 5) {
        interp3 = '<strong>Respiratory compensation</strong>';
      } else if (co2 > expected + 5) {
        interp3 = `<strong>Decomp. resp acidosis</strong><br>CO₂ = ${co2} (exp. ≃ ${expected} ± 5)`;
      } else {
        interp3 = `<strong>2º resp alkalosis</strong><br>CO₂ = ${co2} (exp. ≃ ${expected} ± 5)`;
      }

    /* 2b. Metabolic alkalosis – expected CO₂ ≈ 0.7 × (HCO₃⁻‑24)+40 */
    } else if (naclDelta > 45 && hco3 >= 30) {
      const expected = Math.round(0.7 * (hco3 - 24) + 40);
      if (co2 >= expected - 5 && co2 <= expected + 5) {
        interp3 = '<strong>Appropriate respiratory compensation</strong>';
      } else if (co2 > expected + 5) {
        interp3 = `<strong>Decompensated resp acidosis</strong><br>CO₂ = ${co2} (exp. ≃ ${expected} ± 5)`;
      } else {
        interp3 = `<strong>2º resp alkalosis</strong><br>CO₂ = ${co2} (exp. ≃ ${expected} ± 5)`;
      }

    /* 2c. Primary respiratory disturbance *with* an abnormal HCO₃⁻ band */
    } else {
      let respType = 'No resp disturbance';

      if (deltaCO2 > 0) {                       // respiratory acidosis
        const expA = (deltaCO2 / 10) * 1;
        const expC = (deltaCO2 / 10) * 4;
        if (deltaHCO3 <= expA + 0.5) {
          respType = 'Acute resp acidosis';
        } else if (deltaHCO3 >= expC - 0.5) {
          respType = 'Chronic resp acidosis';
        } else if (deltaHCO3 > expA + 0.5 && deltaHCO3 < expC - 0.5) {
          respType = 'Acute‑on‑chronic resp acidosis';
        } else if (deltaHCO3 > expC + 0.5) {
          respType = 'Resp acidosis + metabolic alkalosis';
        } else if (deltaHCO3 < expA - 0.5) {
          respType = 'Resp acidosis + metabolic acidosis';
        }

      } else if (deltaCO2 < 0) {                // respiratory alkalosis
        const absChange = Math.abs(deltaCO2);
        const expA = -(absChange / 10) * 2;
        const expC = -(absChange / 10) * 5;
        if (deltaHCO3 >= expA - 0.5) {
          respType = 'Acute resp alkalosis';
        } else if (deltaHCO3 <= expC + 0.5) {
          respType = 'Chronic resp alkalosis';
        } else if (deltaHCO3 < expA - 0.5 && deltaHCO3 > expC + 0.5) {
          respType = 'Acute‑on‑chronic resp alkalosis';
        } else if (deltaHCO3 < expC - 0.5) {
          respType = 'Resp alkalosis + metabolic acidosis';
        } else if (deltaHCO3 > expA + 0.5) {
          respType = 'Resp alkalosis + metabolic alkalosis';
        }
      }

      interp3 = `<strong>${respType}</strong>`;
    }
  }
  /* ---------- End respiratory evaluation ---------- */

      set('interp3', interp3);
      // Determine visibility of previous interpretations
      const interp1Visible = interp1El.style.display !== 'none';
      const interp2Visible = interp2El.style.display !== 'none';
      // Base condition: show only if step ≥3 and there is interp3 text
      let interp3ShouldShow = window.maxStep >= 3 && interp3;
      // If both NaClΔ and AG boxes are hidden and CO₂ is within 35–45 with normal metabolic, hide CO₂ box
      if (!interp1Visible && !interp2Visible && Math.abs(deltaCO2) <= 5 && naclDelta >= 30 && ag <= 16) {
        interp3ShouldShow = false;
      }
      document.getElementById('interp3').style.display = interp3ShouldShow ? '' : 'none';

  const ph = (6.1 + Math.log10(hco3 / (0.03 * co2))).toFixed(2);
  document.getElementById('ph').value = ph;
  const phVal = parseFloat(ph);
  const correctedNa = Math.round(na + glucose / 4);
  // Correct K+ normalized to pH 7.40: 0.5 mmol/L change per 0.1 pH unit
  const correctedK = (k - 5 * (7.4 - phVal)).toFixed(1);
  const osmCalc = Math.round(2 * na + glucose);
  const correctedKVal = parseFloat(correctedK);
  let interp4Html = '';
  if (glucose >= 20) {
    interp4Html += `<strong>Na⁺<sub>c</sub>:</strong> ${correctedNa} mmol/L`;
  }
  // Show corrected K only if measured or corrected falls outside normal (3.5–5.2 mmol/L)
  if (k < 3.5 || k >= 5.2 || correctedKVal < 3.5 || correctedKVal >= 5.2) {
    interp4Html += (interp4Html ? '<br>' : '') + `<strong>K⁺<sub>c</sub>:</strong> ${correctedK} mmol/L`;
  }
  // Hypoglycaemia thresholds
  if (glucose < 2.2) {
    interp4Html += (interp4Html ? '<br>' : '') + '<strong>Sev. hypoglycaemia</strong>';
  } else if (glucose >= 2.2 && glucose <= 2.9) {
    interp4Html += (interp4Html ? '<br>' : '') + '<strong>Mod.</strong> hypoglycaemia';
  } else if (glucose >= 3.0 && glucose < 4.0) {
    interp4Html += (interp4Html ? '<br>' : '') + 'Mild hypoglycaemia';
  }
  if (glucose >= 15) {
    interp4Html += (interp4Html ? '<br>' : '') + 'Hyperglycaemia';
  }
  if (lactate > 2.0) {
    interp4Html += (interp4Html ? '<br>' : '') + 'Hyperlactataemia';
  }
  // Removed: if (hb <= 100) { interp4Html += ... }
  if (osmCalc >= 320) {
    interp4Html += (interp4Html ? '<br>' : '') + `Hyperosmolality (${osmCalc})`;
  } else if (osmCalc >= 300) {
    interp4Html += (interp4Html ? '<br>' : '') + `Hyperosmolality (${osmCalc})`;
  }

  const interp4El = document.getElementById('interp4');
  if (window.maxStep < 4 || interp4Html.trim() === '') {
    interp4El.style.display = 'none';
  } else {
    interp4El.style.display = '';
    interp4El.innerHTML = interp4Html;
  }

  // O₂ and Hb section interpretation (using user-entered FiO₂)
  const fio2 = get('fio2');
  const fio2Frac = fio2 / 100;
  const pao2Val = get('pao2');
  const ph2o = 47, patm = 760, r = 0.8;
  const PAO2 = fio2Frac * (patm - ph2o) - co2 / r;
  const aag = Math.round(PAO2 - pao2Val);
  let interpO2hbHtml = '';
  // Only show A–a gradient if greater than 10
  if (aag > 10) {
    interpO2hbHtml = `<strong>A–a gradient:</strong> ${aag} (normal ≃ [age + 10] ÷ 4)`;
    aaPlainText = `Raised A–a gradient (${aag} mmHg)`;
  }
  // Placeholder for F-Hb interpretation, to be appended when available
  const interpO2hbEl = document.getElementById('interpO2hb');
  // Single toggle declaration for O₂/Hb section
  const o2toggle = document.getElementById('toggleO2hb').checked;
  if (interpO2hbHtml && o2toggle) {
    interpO2hbEl.style.display = '';
    interpO2hbEl.innerHTML = interpO2hbHtml;
  } else {
    interpO2hbEl.style.display = 'none';
  }

  // Hb/F-Hb interpretation logic
  const interpHbFhbEl = document.getElementById('interpHbFhb');
  let interpList = [];
  // Anaemia thresholds
  if (hb > 0) {
    if (hb < 70) {
      interpList.push('Severe anaemia, consider transfusion');
    } else if (hb < 80) {
      interpList.push('Significant anaemia');
    } else if (hb < 100) {
      interpList.push('Anaemia');
    }
  }
  // COHb thresholds
  if (fcohb > 2) {
    if (fcohb < 10) {
      let txt = 'Mild CO poisoning';
      if (fcohb < 5) txt += ' (≤5% normal in heavy smokers)';
      interpList.push(txt);
    } else if (fcohb <= 25) {
      interpList.push('Moderate CO poisoning');
    } else {
      interpList.push('Severe CO poisoning (indication for HBOT)');
    }
  }
  // MetHb thresholds
  if (fmethb >= 1) {
    if (fmethb < 5) {
      interpList.push('Mild methemoglobinaemia');
    } else if (fmethb < 15) {
      interpList.push('Moderate methemoglobinaemia');
    } else {
      interpList.push('Severe methemoglobinaemia (indication for methylene blue administration)');
    }
  }
  // (Oxyhaemoglobin / A-a gradient check removed)
  // Fraction summation check (ensure fractions sum to 100%)
  const sumFrac = fo2hb + fcohb + fhhb + fmethb;
  if (Math.abs(sumFrac - 100) >= 1) {
    interpList.push('<em>Please enter all Hb fractions</em>');
  }
  if (o2toggle && interpList.length) {
    interpHbFhbEl.style.display = '';
    // Build output sentence based on number of phrases
    let sentence;
    if (interpList.length === 1) {
      // Single phrase: capitalise first letter, no full stop
      sentence = interpList[0];
      sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);
    } else {
      // Multiple phrases: join with semicolons and end with full stop
      sentence = interpList.join('; ') + '.';
      sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);
      // Lowercase letter immediately following each semicolon, allowing for optional HTML tags
      sentence = sentence.replace(/;\s*((?:<[^>]*>\s*)*)([A-Za-z])/g,
        (match, p1, p2) => '; ' + p1 + p2.toLowerCase()
      );
    }
    interpHbFhbEl.innerHTML = sentence;
    fhbPlainText = sentence.replace(/\.$/, '');
  } else {
    interpHbFhbEl.style.display = 'none';
    interpHbFhbEl.innerHTML = '';
    fhbPlainText = '';
  }

  /* ---------- Ordered summary rebuild ---------- */
  // Convert <br> to " – ", then strip <strong> tags for summary
  const interp3Plain = interp3
    .replace(/<br\s*\/?>/g, ' – ')
    .replace(/<\/?strong>/g, '')
    // Wrap text following " – " in italics
    .replace(/ –\s*(.+)$/, ' – <em>$1</em>')
    .trim();
  const phNum = parseFloat(ph);
  const lifeArr  = [], severeArr = [],
        nagmaArr = [], ragmaArr  = [],
        naArr    = [], kArr     = [],
        gluArr   = [], lacArr   = [],
        aaArr    = [], fhbArr   = [],
        osmArr   = [], acidArr  = [];
  const respArr = [];

  /* pH categories */
  if (window.maxStep >= 4) {
    if (phNum <= 7.00) lifeArr.push('Life-threatening acidaemia');
    else if (phNum >= 7.55) acidArr.push('Severe alkalaemia');
    else if (phNum >= 7.01 && phNum <= 7.24) acidArr.push('Severe acidaemia');
  }

  /* NaClΔ & AG */
  // NaClΔ group always allowed, so leave as is (do not gate)
  if (naclDelta > 45) nagmaArr.push('Hypochloraemic metabolic alkalosis');
  else if (naclDelta <= 25) severeArr.push('Severe NAGMA');
  else if (naclDelta > 25 && naclDelta < 30) nagmaArr.push('NAGMA');

  // Show AG/RAGMA from Step 2 onward – but only add lactate commentary once we reach Step 4
  if (window.maxStep >= 2) {
    if (ag <= 8) ragmaArr.push('Low anion gap');
    else if (ag >= 16 && ag <= 17) ragmaArr.push('Mild RAGMA');
    else if (ag > 17) {
      const extra = ag - 12;
      const ragmaBase = `${ag >= 20 ? 'Severe RAGMA' : 'RAGMA'} (${extra} extra anions`;
      let lactateNote = '';
      if (window.maxStep >= 4) {        // only evaluate lactate once we’re in Step 4
        if (extra > lactate + 1) {
          lactateNote = ` - note: lactate is only ${lactate} – ${glucose >= 20 ? '<strong>check ketones</strong>' : 'check ketones'}`;
        } else if (lactate >= extra + 1 && lactate <= extra + 3) {
          lactateNote = ' - likely due to lactate';
        } else if (lactate > extra + 3) {
          lactateNote = ` - lactate ${lactate} ⇒ ↓AG + ↑AG`;
        }
      }
      const ragmaLine = ragmaBase + lactateNote + ')';
      if (ag >= 20) severeArr.push(ragmaLine);
      else ragmaArr.push(ragmaLine);
    }
  }

  /* Sodium disturbances (corrected) */
  if (window.maxStep >= 4) {
    if (correctedNa < 125) severeArr.push('Severe hyponatraemia');
    else if (correctedNa >= 125 && correctedNa <= 129) naArr.push('Moderate hyponatraemia');
    else if (correctedNa >= 130 && correctedNa <= 134) naArr.push('Mild hyponatraemia');
    else if (correctedNa >= 160) severeArr.push('Severe hypernatraemia');
    else if (correctedNa >= 150 && correctedNa <= 159) naArr.push('Moderate hypernatraemia');
    else if (correctedNa >= 146 && correctedNa <= 149) naArr.push('Mild hypernatraemia');
  }

  /* Potassium (corrected) severity stratification */
  if (window.maxStep >= 4) {
    if (correctedKVal < 2.5) {
      kArr.push('Severe hypokalaemia');
    } else if (correctedKVal < 3.0) {
      kArr.push('Moderate hypokalaemia');
    } else if (correctedKVal < 3.5) {
      kArr.push('Mild hypokalaemia');
    } else if (correctedKVal >= 6.0) {
      kArr.push('Severe hyperkalaemia');
    } else if (correctedKVal >= 5.5) {
      kArr.push('Moderate hyperkalaemia');
    } else if (correctedKVal >= 5.2) {
      kArr.push('Mild hyperkalaemia');
    }
  }

  /* Glucose */
  if (window.maxStep >= 4) {
    if (glucose < 2.0) lifeArr.push('Life-threatening hypoglycaemia');
    else if (glucose >= 2.0 && glucose <= 2.1) severeArr.push('Severe hypoglycaemia');
    else if (glucose >= 2.2 && glucose <= 2.9) gluArr.push('Moderate hypoglycaemia');
    else if (glucose >= 3.0 && glucose < 4.0) gluArr.push('Mild hypoglycaemia');
    else if (glucose >= 15) gluArr.push('Hyperglycaemia');
  }

  /* Osmolality / HHS */
  if (window.maxStep >= 4) {
    if (osmCalc >= 320 && glucose >= 20) {
      severeArr.push(`<strong>HHS</strong> (&gt;${osmCalc})`);
    } else if (osmCalc >= 300) {
      osmArr.push(`Hyperosmolar (&gt;${osmCalc})`);
    }
  }

  /* Lactate */
  if (window.maxStep >= 4) {
    if (lactate > 2.0) lacArr.push('Hyperlactataemia');
  }

  /* A–a gradient */
  if (window.maxStep >= 5 && document.getElementById('toggleO2hb').checked) {
    if (aaPlainText) aaArr.push(aaPlainText);
  }

  /* Respiratory (CO₂) */
  if (window.maxStep >= 3 && interp3Plain) {
    respArr.push(interp3Plain);
  }

  /* F‑Hb (only when O₂/Hb enabled) */
  if (window.maxStep >= 5 && document.getElementById('toggleO2hb').checked) {
    if (fhbPlainText) fhbArr.push(fhbPlainText);
  }

  /* Assemble ordered list */
  const orderedLines = [].concat(
    lifeArr, severeArr,
    nagmaArr, ragmaArr,
    respArr,
    naArr, kArr, gluArr, lacArr,
    osmArr,
    aaArr, fhbArr,
    acidArr            // acidaemia/alkalaemia last
  );

  const summaryEl = document.getElementById('summary');
  const summaryTextEl = document.getElementById('summary-text');

  if (orderedLines.length) {
    const summaryList = '<ul style="margin:0; padding-left:1.2em; list-style-position:outside;">'
                      + orderedLines.map(l => `<li>${l}</li>`).join('')
                      + '</ul>';
    summaryTextEl.innerHTML = '<strong>Summary:</strong><br>' + summaryList;
    summaryEl.style.display = '';
  } else {
    summaryTextEl.innerHTML = '';
    summaryEl.style.display = 'none';
  }
  /* ---------- End ordered summary ---------- */
  
  // Generate recommendations based on the blood gas analysis
  let recommendationsHtml = '';
  let recList = [];
  // Suggest sample error if anion gap is negative
  if (window.maxStep >= 2 && ag < 0) {
    recList.push('Negative anion gap – consider sample or measurement error');
  }
  
  // Add LTKR recommendation for high anion gap
  if (window.maxStep >= 4 && ag > 16) {
    // Add check ketones recommendation if summary check ketones logic triggered
    if ((ag - 12) > lactate + 1 && glucose >= 20) {
      recList.push(`<strong>Check ketones</strong> (glucose ${glucose.toFixed(1)} & ↑AG)`);
    }
    recList.push(`Consider causes of high anion gap: <strong>LTKR</strong> (<strong>L</strong>actate, <strong>T</strong>oxic alcohols, <strong>K</strong>etones, and <strong>R</strong>enal failure)`);
  }
  
  // Add lactate causes if high lactate
  if (window.maxStep >= 4 && lactate > 4.0) {
    recList.push(`High lactate is also seen in salbutamol toxicity (5-10), metformin with AKI (8-20), alcohol toxicity (typically 4-8), cyanide toxicity (10-40)`);
  }
  
  // Add glucose recommendation before pH recommendation (for better semantic flow)
  if (window.maxStep >= 4 && glucose > 20) {
    recList.push(`Suggest IV fluids & consider insulin therapy`);
  }
  // Add recommendation for life‑threatening hypoglycaemia
  if (window.maxStep >= 4 && glucose < 3.0) {
    recList.push('<strong>Urgent</strong> treatment for hypoglycaemia indicated');
  }
  
  // Add other recommendations based on conditions
  if (window.maxStep >= 4 && phNum <= 7.15) {
    recList.push(`Consider avoiding saline as this will ↑Cl⁻ and further ↓pH`);
  }
  
  if (window.maxStep >= 4 && correctedKVal >= 6.0) {
    recList.push(`<strong>Urgent</strong> treatment for hyperkalaemia indicated`);
  } else if (window.maxStep >= 4 && correctedKVal >= 5.2) {
    recList.push(`Monitor potassium closely`);
  }
  
  // Convert recList into a bulleted list and promote life‑threatening items
  if (recList.length > 0) {
    // Capitalise first letter of each recommendation
    const processedRecs = recList.map(rec => rec.charAt(0).toUpperCase() + rec.slice(1));

    // Preserve specific acronyms/chemical symbols
    const termsToPreserve = [
      { term: 'iv',  replace: 'IV'  },
      { term: 'aki', replace: 'AKI' },
      { term: 'ltkr',replace: 'LTKR'},
      { term: 'cl⁻', replace: 'Cl⁻'},
      { term: 'cl-', replace: 'Cl⁻'},
      { term: 'ph',  replace: 'pH'  }
    ];
    processedRecs.forEach((rec, idx) => {
      let txt = rec;
      termsToPreserve.forEach(item => {
        const re = new RegExp('\\b' + item.term + '\\b', 'gi');
        txt = txt.replace(re, item.replace);
      });
      processedRecs[idx] = txt;
    });

    // Identify life‑threatening recommendations
    const lifeThreat = processedRecs.filter(r => /hyperkalaemia|hypoglycaemia/i.test(r));
    const others      = processedRecs.filter(r => !(/hyperkalaemia|hypoglycaemia/i.test(r)));

    // Build HTML bullet list with life‑threatening items first
    const ordered = lifeThreat.concat(others);
    recommendationsHtml = '<ul style="margin:0; padding-left:1.2em; list-style-position:outside;">'
                        + ordered.map(r => '<li>' + r + '</li>').join('')
                        + '</ul>';
  }
  
  // Set recommendations and show/hide title based on content
  document.getElementById('recommendations-text').innerHTML = recommendationsHtml;
  document.getElementById('recommendations-title').style.display = recommendationsHtml ? '' : 'none';
  document.getElementById('recommendations-container').style.display = recommendationsHtml ? '' : 'none';
  
  // Call repositionSummary to ensure proper placement
  repositionSummary();
}

function initTabNavigation() {
  const steps = Array.from(document.querySelectorAll('.step'));
  steps.forEach((stepDiv, idx) => {
    const inputs = stepDiv.querySelectorAll('input');
    inputs.forEach((inp, i) => {
      inp.addEventListener('focus', () => showStep(idx + 1));
      inp.addEventListener('keydown', e => {
        if (!e.shiftKey && e.key === 'Tab' && i === inputs.length - 1) {
          e.preventDefault();
          const next = idx + 1 < steps.length ? idx + 1 : idx;
          const nextInputs = steps[next].querySelectorAll('input');
          showStep(next + 1);
          if (nextInputs[0]) nextInputs[0].focus();
        }
      });
    });
  });
}
function repositionSummary() {
  const summaryEl = document.getElementById('summary');
  // Remove summary from its current position
  summaryEl.remove();
  // Always append summary to .main (outside the scrollable .content)
  const mainEl = document.querySelector('.main');
  mainEl.appendChild(summaryEl);
}
showStep(1, true);
update();
initTabNavigation();

// Toggle O₂ and Hb analysis fields (show inputs/labels, show interpretations only if content)
document.getElementById('toggleO2hb').addEventListener('change', function() {
  const showFields = this.checked;
  // Show/hide only input fields and labels
  document.querySelectorAll('.o2hb-field').forEach(el => {
    if (el.tagName === 'INPUT' || el.tagName === 'LABEL') {
      el.style.display = showFields ? '' : 'none';
    }
  });
  // Show/hide interpretation boxes based on content
  ['interpO2hb', 'interpHbFhb'].forEach(id => {
    const el = document.getElementById(id);
    if (showFields && el.innerHTML.trim()) {
      el.style.display = '';
    } else {
      el.style.display = 'none';
    }
  });
  repositionSummary();
  update();
});

// Initialise O₂ and Hb analysis based on checkbox and content
(function() {
  const showFields = document.getElementById('toggleO2hb').checked;
  document.querySelectorAll('.o2hb-field').forEach(el => {
    if (el.tagName === 'INPUT' || el.tagName === 'LABEL') {
      el.style.display = showFields ? '' : 'none';
    }
  });
  ['interpO2hb', 'interpHbFhb'].forEach(id => {
    const el = document.getElementById(id);
    if (showFields && el.innerHTML.trim()) {
      el.style.display = '';
    } else {
      el.style.display = 'none';
    }
  });
  repositionSummary();
})();
// Format Glucose, K⁺, and Lactate on blur to one decimal place
['glucose', 'k', 'lactate'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('blur', function() {
    const val = parseFloat(this.value) || 0;
    this.value = val.toFixed(1);
    update();
  });
});

// Format HCO₃⁻ and CO₂ on blur: remove trailing .0 if integer, otherwise one decimal
['hco3', 'co2'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('blur', function() {
    const val = parseFloat(this.value) || 0;
    if (val % 1 === 0) {
      this.value = val.toString();
    } else {
      this.value = val.toFixed(1);
    }
    update();
  });
});
// Format Na⁺ and Cl⁻ on blur to whole numbers
['na','cl'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('blur', function() {
    const val = Math.round(parseFloat(this.value) || 0);
    this.value = val;
    update();
  });
});


</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const tabsEl = document.querySelector('.tabs');
  if (tabsEl) {
    tabsEl.addEventListener('touchmove', function(e){
      e.preventDefault();
    }, { passive: false });
  }
});
</script>
<script>
(function(){
  function restrictToPositiveNumbers(input) {
    // Allow arrow keys and select-all commands
    input.addEventListener('keydown', function(e) {
      // Up/down arrows step the value
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        e.preventDefault();
        const step = parseFloat(input.getAttribute('step')) || 1;
        let val = parseFloat(input.value) || 0;
        val = e.key === 'ArrowUp' ? val + step : val - step;
        // Prevent negative
        if (val < 0) val = 0;
        // Apply to one or zero decimals based on step
        const precision = (step.toString().split('.')[1] || '').length;
        input.value = precision ? val.toFixed(precision) : Math.round(val);
        input.dispatchEvent(new Event('input'));
        return;
      }
      // Permit left/right arrows for navigation
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') return;
      // Permit select-all (Cmd+A / Ctrl+A)
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'a') return;
    });
    input.addEventListener('beforeinput', function(e) {
      if (e.inputType !== 'insertText') return;
      const char = e.data;
      const val = this.value;
      const start = this.selectionStart;
      const end = this.selectionEnd;
      if (/^[0-9]$/.test(char)) return;
      if (char === '.') {
        const newVal = val.slice(0, start) + '.' + val.slice(end);
        if ((newVal.match(/\./g) || []).length <= 1) {
          return;
        }
      }
      e.preventDefault();
    });
    input.addEventListener('paste', function(e) {
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      if (!/^\d*\.?\d*$/.test(paste)) {
        e.preventDefault();
      }
    });
    input.addEventListener('drop', function(e) {
      e.preventDefault();
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input.value-field').forEach(function(input) {
      restrictToPositiveNumbers(input);
      input.addEventListener('focus', function() {
        var el = this;
        setTimeout(function(){ el.select(); }, 0);
      });
    });
  });
})();
</script>
<script>
// Prevent touch dragging on the summary panel if there's no overflow
document.addEventListener('DOMContentLoaded', function() {
  const summaryEl = document.getElementById('summary');
  if (summaryEl) {
    summaryEl.addEventListener('touchmove', function(e) {
      // Block dragging when content fits; allow only if scrollable
      if (summaryEl.scrollHeight <= summaryEl.clientHeight) {
        e.preventDefault();
      }
    }, { passive: false });
  }
});
</script>
</body>
</html>
